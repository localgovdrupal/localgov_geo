<?php

namespace Drupal\Tests\localgov_geo_update\Functional;

use Drupal\geo_entity\Entity\GeoEntity;
use Drupal\geo_entity\Entity\GeoEntityType;
use Drupal\localgov_geo_update\Entity\LocalgovGeo;
use Drupal\Tests\BrowserTestBase;

/**
 * Updates a localgov geo entity and checks fields and display works.
 *
 * @group localgov_geo
 */
class UpdateLocalgovGeoTest extends BrowserTestBase {

  /**
   * {@inheritdoc}
   */
  protected static $modules = [
    'system',
    'text',
    'field_ui',
    'localgov_geo',
    'localgov_geo_update',
    'localgov_geo_update_to_geo_test',
    'geo_entity',
    'token',
  ];

  /**
   * Permissions for the admin user that will be logged-in for test.
   *
   * @var array
   */
  protected static $adminUserPermissions = [
    'access geo overview',
    'delete geo',
    'create geo',
    'edit geo',
    'administer geo types',
  ];

  /**
   * An admin test user account.
   *
   * @var \Drupal\Core\Session\AccountInterface
   */
  protected $adminUser;

  /**
   * A non-admin test user account.
   *
   * @var \Drupal\user\UserInterface
   */
  protected $nonAdminUser;

  /**
   * {@inheritdoc}
   */
  protected $defaultTheme = 'stark';

  /**
   * Test an update from a localgov_geo entity to a geo_entity.
   */
  public function testUpdateOfLocalgovGeo() {

    // Create a localgov geo entity.
    $localgov_geo_content = [
      'localgov_update_test_id' => 'A',
      'localgov_update_test_details' => 'Lorem impsum',
      'location' => 'POLYGON ((-0.19935850089930177 50.82884193862926,-0.19921239223795123 50.829163712257085,-0.1991008364974425 50.829446361525875,-0.1987443435240854 50.8303040443036,-0.19840903152091915 50.83112023373138,-0.19833790712297833 50.831296913358834,-0.1988047123539887 50.831375372862475,-0.198613674610501 50.83184040844282,-0.1988129462167622 50.831870246742085,-0.19866290766629396 50.83227320838192,-0.19745477112120627 50.83209278947115,-0.19743652839269868 50.83210554804918,-0.195927716742811 50.831887071080764,-0.1951460749697043 50.831772592460794,-0.1941927888300145 50.83163314845972,-0.19416291950753142 50.83171533546935,-0.19413273154119726 50.83179841687847,-0.1941077889098908 50.83186701016543,-0.19410297617527636 50.831881325107275,-0.19407356351971797 50.831962709755175,-0.19406156631323201 50.83199759830191,-0.1940441539284609 50.83204769180111,-0.19402882935686255 50.83209152223711,-0.19401488298426814 50.8321290786267,-0.19399697217487935 50.83217736572403,-0.19398350356139132 50.83221358049548,-0.19396878157331487 50.832252833618554,-0.19395357133886773 50.832293697993165,-0.193941681494311 50.83232580023582,-0.19392234749029044 50.83237784251688,-0.19391386078801456 50.832400878132674,-0.1938915909353256 50.832460915057865,-0.19388541747014748 50.83247736734095,-0.19386050184436382 50.83254524151792,-0.19385732332187253 50.832554005841445,-0.19383078018237426 50.83262725085474,-0.19380257861577463 50.83270298833876,-0.19379416483687545 50.83272597111384,-0.19377590378154358 50.83277596149817,-0.19376383012301943 50.8328091400834,-0.19374748030358707 50.83285376401356,-0.1937314420638567 50.83289767329334,-0.19372141463787057 50.83292566738289,-0.19370024828531926 50.83298469610585,-0.19369515491645217 50.83299891675098,-0.19366906132623216 50.83307153914709,-0.19364152027746134 50.83314854589098,-0.19363624912183944 50.83315955016118,-0.1936143219795524 50.83322402905732,-0.19360493846064342 50.83325005455838,-0.19358710277146168 50.833300051496835,-0.1935603578386622 50.83337482219735,-0.19354444728194614 50.83341909316235,-0.19353347782824154 50.833449410932005,-0.19351328054486078 50.83350539686848,-0.19350643497914224 50.833524536742445,-0.19348161849681444 50.83359349157557,-0.19347908735985533 50.833600197431025,-0.1934513902039364 50.833673874153874,-0.19344616515995888 50.83368782294676,-0.19342304889109416 50.833749519442485,-0.19341653222461333 50.8337674952622,-0.1933958845710758 50.833824103741115,-0.19339175017567184 50.83383555126865,-0.19336503236695127 50.83390960286978,-0.19296074216747244 50.83386107305259,-0.19276786992856845 50.8339021250135,-0.19235494699170597 50.83385183616048,-0.19185326375506434 50.833791529740324,-0.19132222340158075 50.833723716701236,-0.19075224605310948 50.833657639631696,-0.19010105418559986 50.83357580622186,-0.18948745397471534 50.833498558417844,-0.18932802544824207 50.83354442660426,-0.18861384188511565 50.833463500926186,-0.18864334682734923 50.83335075154915,-0.18823181101152853 50.83330254246323,-0.18801915434022132 50.83338042347212,-0.18773244698000646 50.833347668253175,-0.18765398300429167 50.83333853527636,-0.1876346046786973 50.83333616578171,-0.18760461208847162 50.8333324802491,-0.18757341798529062 50.833328650136764,-0.18751416911686164 50.83332133543755,-0.187420914349407 50.83330982311087,-0.18744289568671785 50.83323363075349,-0.1873616456285332 50.83322310528592,-0.18726767779336728 50.83321094322566,-0.18710800599165434 50.833190205737296,-0.18705798819114758 50.8331797427381,-0.186895895428043 50.83322781954159,-0.18676988544967887 50.83321111330977,-0.18672734805966948 50.83320536196397,-0.1866667797364626 50.833197288867446,-0.18656721977676594 50.83318444828859,-0.18656103553164924 50.83319951252061,-0.18652022125124681 50.83319437245205,-0.18651647183888678 50.833206104524656,-0.18607782286755356 50.83315036160206,-0.1860817717574464 50.833140080582005,-0.1859052421948827 50.83311340640983,-0.1859061549585429 50.833110899360534,-0.1858745920669028 50.83310629082221,-0.18578300429286335 50.83309465920593,-0.18580987707361704 50.833010958062225,-0.18552278365308722 50.83297589277274,-0.18555861828207731 50.83287212657584,-0.18556506211611049 50.83285244129841,-0.18559091658903182 50.832775320228194,-0.18559950420019505 50.832751621255184,-0.18562593575358044 50.83267792664421,-0.18563344968671863 50.832656279454824,-0.18565998568038014 50.83257988843856,-0.18566781131304236 50.83255752662159,-0.1856952161698924 50.83248069943779,-0.18570348496970318 50.83245789483943,-0.18572961839158514 50.83238455530346,-0.18573935615240225 50.83235682717244,-0.1857540650973245 50.83231442715867,-0.1857646065435779 50.83228428330339,-0.1857681829339186 50.83227408643436,-0.18577645064561613 50.83224984286886,-0.18578782713773637 50.83221647437042,-0.18579920012831744 50.83218319575037,-0.1858105800715371 50.83214973736914,-0.18582191121244995 50.8321175373045,-0.18583500910136153 50.8320800586015,-0.18584634369202677 50.8320477686539,-0.18586933151893245 50.83198229436927,-0.18589265191053683 50.83191556617409,-0.18591640497372927 50.83184866483315,-0.1859179844971427 50.83184455242618,-0.18594042439189284 50.83178221729867,-0.18594120718258605 50.831780340854706,-0.18596482514821222 50.831713257534616,-0.18596562535843297 50.83171093169109,-0.18598743215964397 50.831646608161456,-0.1860110369807889 50.831576197067115,-0.18559829657671564 50.83151923624593,-0.1854242363492516 50.831492516874356,-0.18500740609889924 50.83143486080647,-0.18487464392877556 50.83141615764156,-0.1849412339232625 50.83122608370675,-0.18500556267915744 50.83105744666351,-0.1850567384923874 50.83090615044421,-0.18509812304657833 50.83078380034842,-0.18704783855668836 50.83105945310323,-0.18712867308447945 50.830835648050744,-0.1874050490125388 50.830874522885416,-0.18750906277785065 50.83060143323894,-0.1882817411012274 50.83071456700258,-0.1884199266200959 50.83035472819501,-0.1885010450469425 50.83018511302317,-0.1887186262421268 50.83021367261959,-0.18878367329929524 50.83000063941046,-0.1890257320039034 50.830035154336535,-0.1891950507393483 50.83005954641403,-0.18921150537425938 50.83000862932937,-0.18922029580950797 50.829979627131266,-0.1892304782679046 50.829947678713665,-0.18924795822200383 50.82989228083454,-0.18925866377349665 50.829857822379545,-0.18927230290821537 50.82981360664191,-0.18927343892192844 50.82980993697701,-0.18929159772768514 50.829751671737036,-0.18929906144626168 50.829727595314374,-0.18931208414422698 50.82968462908129,-0.1893246323780805 50.82964291455976,-0.18933456910542967 50.82960997304404,-0.18935216008269312 50.82955169898125,-0.18936176772739835 50.829519921498445,-0.18937152075298846 50.829488056336864,-0.18938839443534097 50.8294336383002,-0.1893984695089173 50.82940078885948,-0.189415363990525 50.82934583153699,-0.1894244240879373 50.829317193242844,-0.1894493392964178 50.82923843792898,-0.18940764441144814 50.82923338411348,-0.18943297622822572 50.82914753047756,-0.1894746919036361 50.82915204500283,-0.18950048689564836 50.829068896561175,-0.18950374247664029 50.82905815499536,-0.18952967297056658 50.82897150122134,-0.189547748301842 50.828911705763005,-0.1895604693101432 50.82886918448782,-0.1895660246104313 50.82885038454135,-0.1895845151580828 50.82879086532196,-0.18960387233686976 50.82872362521843,-0.18961314711993038 50.828693101624246,-0.18962423676654747 50.82865604100458,-0.18964166074234842 50.82859839384025,-0.1896450755542461 50.82858720507053,-0.18966360239600452 50.82852674209282,-0.1896707523310598 50.82850342521439,-0.18967221730597045 50.82849859150684,-0.18969318047706682 50.828430207163535,-0.18970081696596577 50.82840532398668,-0.18971703514508167 50.82834984349779,-0.18973040768690416 50.82830478717746,-0.189756666331454 50.82821696929603,-0.18976335044867434 50.82819467942537,-0.1897766518159315 50.82815035945408,-0.18979480724162437 50.82808994465084,-0.18980250531116252 50.82806456778468,-0.18981840914455414 50.82801206821359,-0.18981922647830377 50.82800929293898,-0.18984576164818823 50.82792165919369,-0.18985098074130785 50.827904203026684,-0.18985292703639853 50.827897937839346,-0.18985527510484035 50.827890096046026,-0.18986364191714117 50.82786211246981,-0.18987233495463396 50.82783303675869,-0.1898845774697873 50.82779185703122,-0.1898984302765688 50.827745755912105,-0.18991278179134033 50.827697773913044,-0.18992330640679375 50.82766282693934,-0.18992434882320805 50.82765937165705,-0.18994006152670712 50.82760556505822,-0.18995003906674884 50.82757154490854,-0.1899713171006417 50.82749866869118,-0.18997425387221412 50.82748882150534,-0.19000073976749904 50.82740244603325,-0.19000495085380276 50.82738902125343,-0.19002688960014186 50.82731741435193,-0.19003451181133776 50.827292890665554,-0.1900538531630423 50.827229697265864,-0.19006381315382684 50.82719612650338,-0.1900788362326462 50.82714545687769,-0.1900928618333026 50.82709854900676,-0.19010528061403492 50.82705647264713,-0.190120795367763 50.82700410189541,-0.19012976477161223 50.82697411312261,-0.19015766975086962 50.826884072328006,-0.19022671291897855 50.82665185435969,-0.19024257296418848 50.82659994155013,-0.1902668848211344 50.826512630012765,-0.1902749761834046 50.82648120048056,-0.19047218501108173 50.82649530364104,-0.1906383812012835 50.826517042964504,-0.1916345393278083 50.82661612635599,-0.19284478439657932 50.826791750937446,-0.1939961060357989 50.82701197241548,-0.19461145497868965 50.82715844152014,-0.19551135462702013 50.82740686639349,-0.19656123833229672 50.827752258287916,-0.1973939328338015 50.82803178104787,-0.19806098400913885 50.828228266686374,-0.19881153342204902 50.82841633369333,-0.19897834704335585 50.828448811923415,-0.19949544005087025 50.82854389848924,-0.19948106037835445 50.82857681282193,-0.19935850089930177 50.82884193862926))',
    ];
    $localgov_geo_entity = LocalgovGeo::create([
      'bundle' => 'update_test',
    ] + $localgov_geo_content);
    $localgov_geo_entity->save();
    $localgov_geo_title = (string) $localgov_geo_entity->label();

    // Run the update scripts as needed.
    // Note this should be an update test, though as we are testing limited
    // number of updates for a specific scenario we can just execute directly.
    localgov_geo_update_update_8002();
    localgov_geo_update_update_8003();

    // Check that the equivilent geo entity exits.
    $geo_type = GeoEntityType::load('update_test');
    $this->assertInstanceOf(GeoEntityType::class, $geo_type);

    // Check that the geo entity has the same fields.
    $stub_geo = GeoEntity::create(['bundle' => 'update_test']);
    $stub_geo->save();
    $this->assertTrue($stub_geo->hasField('localgov_update_test_id'));
    $this->assertTrue($stub_geo->hasField('localgov_update_test_details'));
    $this->assertTrue($stub_geo->hasField('location'));

    // Delete the stub geo beacuse the entity copy intentionally copies
    // the same IDs from localgov_geo.
    $stub_geo->delete();

    // Copy the field content over from the localgov_geo to the geo_entity.
    // Since there should only be 1 entity, we can provide a fake sandbox.
    $sandbox = [];
    localgov_geo_update_update_8004($sandbox);

    // Find the geo entity equivilent of the localgov_geo entity.
    $geo_entities = \Drupal::entityTypeManager()
      ->getStorage('geo_entity')
      ->loadByProperties(['label' => $localgov_geo_title]);
    $geo_entity = reset($geo_entities);
    $this->assertInstanceOf(GeoEntity::class, $geo_entity);

    // Check the geo entity has the same fields.
    $this->assertEquals($localgov_geo_title, (string) $geo_entity->label());
    $this->assertEquals($localgov_geo_content['localgov_update_test_id'], $geo_entity->localgov_update_test_id->value);
    $this->assertEquals($localgov_geo_content['localgov_update_test_details'], $geo_entity->localgov_update_test_details->value);
    $this->assertEquals($localgov_geo_content['location'], $geo_entity->location->value);

  }

}
